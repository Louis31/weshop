/*!
 * 进货入库
 */
Ext.onReady(function(){
	
	Ext.QuickTips.init();
	
	var SpxxObj = [
		{ name:'spid', type:'string'},
		{ name:'spname', type:'string'},
		{ name:'xinghao', type:'string'},
		{ name:'dw', type:'string'},
		{ name:'jhprice', type:'string'},
		{ name:'chprice', type:'string'},
		{ name:'minnum', type:'string'},
		{ name:'csname', type:'string'},
		{ name:'bz', type:'string'},
		{ name:'lbid', type:'int'},
		{ name:'lbname', type:'string'}
	];
	var v_spid="0", v_spname=""
	//商品数据
	var jhspStore = new Ext.data.JsonStore({
	    url: ctx+'/spxx/findPageSpxx.do',
	    root: 'root',
	    totalProperty: 'total',
	    fields: SpxxObj,
	    listeners:{beforeload:function(a){a.baseParams={start:v_start, limit:v_limit};}}
	});
	
	//评论列表
    var jhspGrid = new Ext.grid.GridPanel({
    	id:'djspGrid',
        store: jhspStore,
        cm: new Ext.grid.ColumnModel({
			defaults: {	menuDisabled : true},//禁止表头菜单
			columns:[
			     new Ext.grid.RowNumberer(),
				{header: '商品编号', width: 100, sortable:true, dataIndex: 'spid'},
	            {header: '商品名称', width: 200, sortable:true, dataIndex: 'spname'},
	            {header: '评价星级', width: 150, sortable:true, dataIndex: 'xinghao'},
	            {header: '发布者', width: 100, sortable:true, dataIndex: 'dw'},
	            {header: '发布时间', width: 100, sortable:true, align:'right', renderer:zhMoney, dataIndex: 'cbj'},
	            {header: '浏览评价', width: 100, sortable:true, align:'center', dataIndex: 'sl'},
	            {header: '管理', width: 100, sortable:true, align:'center', dataIndex: 'spid',renderer:function(){
	            	return "<a>删除</a>";
	            }}
	            ]
        }),
        stripeRows: true, 	//行分隔符
        columnLines : true, //列分隔符
        margins:'20',
        style:'border:1px solid',
		region:'center',
        iconCls:'',
        
        tbar:[{
        	text:'★好差',
        	iconCls:'',
        	handler: function(){
        		bsspWindow.show();
        	}
        },'-',{
        	text:'★★差',
        	iconCls:'',
        	handler: function(){
        		
        	}
        },'-',{
        	text:'★★★良好',
        	iconCls:'',
        	handler: function(){
        		var record= jhspGrid.getSelectionModel().getSelected();
        	}
        },'-',{
        	text:'★★★★好',
        	iconCls:'',
        	handler: function(){
        		var record= jhspGrid.getSelectionModel().getSelected();
        	}
        }
        ,'-',{
        	text:'★★★★★非常好',
        	iconCls:'',
        	handler: function(){
        		var record= jhspGrid.getSelectionModel().getSelected();
        	}
        }
        ],
    bbar: new Ext.PagingToolbar({
        pageSize: 15,
        store: jhspStore,
        displayInfo: true
    })
        ,
        listeners:{
             	render:function(){
             		var tbar = new Ext.Toolbar ({
             			items:[
             			    {
             	        	text:'设为置顶',
             	        	iconCls:'btn-edit',
             	        	handler: function(){
             	        		var record= grid.getSelectionModel().getSelected(); 
             	        	}
             	           },{
                	        	text:'删除所选',
                 	        	iconCls:'btn-edit',
                 	        	handler: function(){
                 	        		var record= grid.getSelectionModel().getSelected(); 
                 	        	}
                 	           },
                 	          {
                    	        	text:'设为置顶',
                    	        	iconCls:'btn-edit',
                    	        	handler: function(){
                    	        		var record= grid.getSelectionModel().getSelected(); 
                    	        	}
                    	      }
             			]
             		});
             tbar.render(jhspGrid.tbar);
            },
             
        	rowdblclick:function(){
        		var record= jhspGrid.getSelectionModel().getSelected(); 
				if(record){
	        		addJhWindow.show();
	        		addJhWindow.buttons[0].setVisible(false);
	        		record.set("update","true");
					addJhForm.getForm().loadRecord(record);
				}
        	}
        }
    });
    
	//供应商下拉数据
    var gysStore = new Ext.data.JsonStore({
		url: ctx+'/gys/findGysComb.do',
	    root: 'root',
	    totalProperty: 'total',
	    fields: ['value','text'],
	    listeners:{
	    	load:function(s){
	    		r = s.getAt(0);
	    		if(r){
	    			Ext.getCmp("gyscombo").onSelect(r, 0);
	    		}
	    	}
	    }
	});
    
	//商品类别树窗口
    var PositionTreeWindow = new Ext.Window({
		width:200,
		height:300,
		closeAction:'hide',
		layout : 'fit',
		buttonAlign : 'center',
		items : [{
			xtype:'treepanel',
			useArrows: true,
	        autoScroll:true,
	        enableDD:false,
	        containerScroll: true,
	        dataUrl: ctx+'/position/findPositionTree.do',
	        root: {
	            nodeType: 'async',
	            text: '所有类别',
	            draggable: false,
	            id: '0'
	        },
	        listeners:{
	        	click:function(n){
	        		if(n.id=="0"){
	        			PositionTreeWindow.buttons[0].setDisabled(true);
	        		}else{
	        			PositionTreeWindow.buttons[0].setDisabled(false);
		        		v_spid = n.id;
		        		v_spname = n.text;
	        		}
	        	},
	        	dblclick:function(n){
	        		if(n.id=="0"){
	        			PositionTreeWindow.buttons[0].setDisabled(true);
	        		}else{
	        			PositionTreeWindow.buttons[0].setDisabled(false);
		        		v_spid = n.id;
		        		v_spname = n.text;
		        		PositionTreeWindow.hide();
						//addForm.getForm().findField("lbid").setValue(v_lbid);
						//addForm.getForm().findField("lbname").setValue(v_lbname);
	        		}
	        	}
	        }
		}],
		listeners:{
			beforeshow:function(){
				var xy = Ext.getCmp("sptext").getPosition();
				PositionTreeWindow.setPosition(xy[0],xy[1]+25);
			},
        	show:function(){
        		this.items.get(0).getRootNode().expand();
        	}
        },
		buttons : [{
			width:60,
			text : '选择',
			disabled : true,
			handler : function() {
				PositionTreeWindow.hide();
				jhdForm.getForm().findField("sp_id").setValue(v_spid);
				jhdForm.getForm().findField("sp_name").setValue(v_spname);
			}
		}, {
			width:60,
			text : '',
			handler : function() {
				PositionTreeWindow.hide();
				v_spid = "0";
				v_spname = "";
			}
		}]
	});
	
    //进货表单
	var jhdForm = new Ext.FormPanel({
		id:'djForm',
		region:'north',
		height: 110,
		border : false,
		layout : 'form',
		labelWidth:60,
		padding : 20,
		items:[{
			id:"jhdfieldset",
			xtype:"fieldset",
			title:"单号：",
			padding:'0 20 0 15',
			items:[{
				layout:"column",
				defaults:{
					xtype:"container",
					autoEl:"div",
					columnWidth:0.2,
					labelAlign:'right',
					layout:"form"
				},
				items:[{
					items:[{
							width:100,
							id:'gyscombo',
							xtype:'combo',
							hiddenName:'gysid',
							fieldLabel:'供应商',
							mode: 'local',
							triggerAction: 'all',
							valueField :'value',
							displayField: 'text',
							allowBlank : false,
							editable : false,
							store : gysStore,
							listeners:{
								select : function(a,b){
									jhdForm.getForm().findField("gysname").setValue(b.data.text);
								}
							}
					}]
				},{
					items:[{
						xtype:"numberfield",
						name:'yfje',
						fieldLabel:"应付金额",
						style:"background:#F6F6F6",
						readOnly:true,
						anchor:"90%",
						maxLength :200
					}]
				},{
					items:[{
						xtype:"numberfield",
						name:'sfje',
						fieldLabel:"实付金额",
						allowBlank : false,
						anchor:"90%",
						maxLength :200
					}]
				},{columnWidth:0.1},{
					items:[{
						id:'jhriqi',
						xtype:"datefield",
						name:'riqi',
						fieldLabel:"收货日期",
						format:'Y-m-d',
						allowBlank : false,
						value:new Date(),
						anchor:"90%",
						listeners:{
							select : function(a,b){
								getCode(b.format("Y-m-d"));
							}
						}
					}]
				}]
			},{
				layout:"column",
				defaults:{
					xtype:"container",
					autoEl:"div",
					labelAlign:'right',
					layout:"form"
				},
				items:[{
					columnWidth:0.4,
					items:[{
						xtype:"textfield",
						name:'bz',
						fieldLabel:"备&nbsp;&nbsp;&nbsp;注",
						anchor:"95%",
						maxLength :200
					}]
				},{
					columnWidth:0.2,
					items:[{
						xtype:'combo',
						hiddenName:'jystate',
						fieldLabel:'是否付款',
						mode: 'local',
						triggerAction: 'all',
						valueField :'value',
						displayField: 'text',
						allowBlank : false,
						editable : false,
						anchor:"90%",
						value:'1',
						store : new Ext.data.SimpleStore({
						    fields: ['value', 'text'],
						    data : [['1','已付'],['0','未付']]
						})
					}]
				},{
					columnWidth:0.2,
					items:[{
						id:'sptext',
						anchor:"90%",
						xtype : 'textfield',
						name:'sp_name',
						fieldLabel:'所属库位',
						allowBlank : false,
						maxLength :50,
						enableKeyEvents:true,
						listeners:{
							focus:function(){
								PositionTreeWindow.show();
							},
							blur:function(){
								jhdForm.getForm().clearInvalid();
							}
						}
					}]
				},{
					columnWidth:0.2,
					items:[{
						width : 145,
						xtype : 'hidden',
						name:'sp_id'
					}]
				},{
					columnWidth:.2,
					items:[{
						width:75,
						xtype:"button",
						text:'保存',
						handler:function(){
							var f = jhdForm.getForm();
							if (f.isValid()) {
								if(jhspStore.getCount()<=0){
									Ext.Msg.alert("信息提示","请添加商品");
									return;
								}
								var jsonArray = [];
						        jhspStore.each(function(item) {
						            jsonArray.push(item.data);
						        });
								f.submit({
									url : ctx+'/jh/saveOrUpdateJhd',
									params :{djsps:JSON.stringify(jsonArray)},
									success : function(form, action) {
										Ext.Msg.alert("信息提示","数据保存成功",function(){
											getCode();
											f.findField("bz").setValue("");
											f.findField("yfje").setValue("");
											f.findField("sfje").setValue("");
											f.clearInvalid();
											jhspStore.removeAll();
										});
									},
									failure : function(form, action) {
										if(action.result && action.result.errors){
											Ext.Msg.alert('信息提示',action.result.errors);
										}else{
											Ext.Msg.alert('信息提示','连接失败');
										}
									}
								});
							}
						}
					}]
				}]
			},{
				xtype:'hidden',
				name:'djid'
			},{
				xtype:'hidden',
				name:'gysname'
			}]
		}]
	});
	//设置单据编号
	var getCode = function(){
		var ymd = Ext.getCmp("jhriqi").getValue().format("Y-m-d");
		Ext.Ajax.request({
   			url : ctx+"/jh/getDjCode.do",
   			params : {tab:'Jhd',ymd:ymd},
   			success : function(o) {
   				if(o.responseText){
   					var code = "JH"+o.responseText;
   					Ext.getCmp("jhdfieldset").setTitle("单号："+code);
   					jhdForm.getForm().findField("djid").setValue(code);
   				}
   			}
   		});
	};
	
	//布局
    new Ext.Viewport({
		layout:'fit',
		items:[{
			frame:true,
			title:'',
			iconCls:'menu-11',
			layout:'border',
			items:[jhspGrid]
		}],
		listeners:{
			render:function(){
				getCode();
				gysStore.load();
			}
		}
	});
	

	

});